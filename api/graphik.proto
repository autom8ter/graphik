syntax = "proto3";

package api;

option go_package = "apipb";

import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/any.proto";
import "google/protobuf/empty.proto";

enum Op {
  CREATE_NODES = 0;
  PATCH_NODES = 1;
  DELETE_NODES = 2;
  CREATE_EDGES = 3;
  PATCH_EDGES = 4;
  DELETE_EDGES = 5;
  SET_AUTH  = 6;
}

enum Cascade {
  CASCADE_NONE =0;
  CASCADE_FROM =1;
  CASCADE_TO=2;
  CASCADE_MUTUAL=3;
}

enum Keyword {
  INVALID =0;
  ANY =1;
  DEFAULT =2;
}
message Path {
  string type =1;
  string id =2;
}

message Node {
  string type =1;
  string id =2;
  google.protobuf.Struct attributes =3;
  int64 created_at =4;
  int64 updated_at =5;
}

message Edge {
  string type =1;
  string id =2;
  google.protobuf.Struct attributes =3;
  Cascade cascade =4;
  Path from =5;
  Path to =6;
  int64 created_at =10;
  int64 updated_at =11;
}

message TypeFilter {
  string type =1;
  repeated string expressions =2;
  int32 limit =3;
}

message PathFilter {
  string type =1;
  string id =2;
  repeated string expressions =3;
  int32 limit =4;
}

message Command {
  Op op =1;
  google.protobuf.Any val =2;
  int64 timestamp =3;
}

message Export {
  repeated google.protobuf.Struct nodes =1;
  repeated google.protobuf.Struct edges=2;
}

message Pong {
  string message =1;
}

message RaftNode {
  string node_id =1;
  string address =2;
}

message AuthConfig {
  repeated string jwks_sources =1;
  repeated string auth_expressions =2;
}

message RaftConfig {
  string bind =1;
  string storage_path =2;
  string join =3;
  string node_id =4;
}

message HTTPConfig {
  string bind =1;
  repeated string allowed_origins=2;
  repeated string allowed_headers =3;
  repeated string allowed_methods =4;
}

message GRPCConfig {
  string bind =1;
}

message Config {
  HTTPConfig http =1;
  GRPCConfig grpc =2;
  RaftConfig raft =3;
  AuthConfig auth =4;
}

service PrivateService {
  rpc Ping(google.protobuf.Empty) returns(Pong) {}
  rpc JoinCluster(RaftNode) returns(google.protobuf.Empty) {}
  rpc GetAuth(google.protobuf.Empty) returns(AuthConfig){}
  rpc SetAuth(AuthConfig) returns(AuthConfig){}
}